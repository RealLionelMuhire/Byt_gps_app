# React Native UI Updates for Trips Feature

This document describes the UI updates needed in your React Native app to support the trips backend implemented in this chat.

**Base URL:** `http://164.92.212.186:8000` (or your server)

**Auth:** No authentication required. All endpoints are open.

---

## 1. API Client Setup

No authentication headers required. Use standard `Content-Type: application/json` for POST/PUT requests.

---

## 2. Trip Types / Interfaces

```typescript
// Trip (list & create response)
interface Trip {
  id: number;
  device_id: number;
  user_id: number;
  name: string;
  display_name: string | null;  // Human-readable from geocoding, e.g. "KG 217 Street → KG 17 Avenue"
  start_time: string;          // ISO 8601
  end_time: string;
  total_distance_km: number;
  created_at: string;
}

// Trip detail (includes route for map)
interface TripDetail extends Trip {
  device_name: string;
  device_imei: string;
  route: {
    type: 'LineString';
    coordinates: [number, number][];  // [lon, lat]
    timestamps: string[];
    speeds: number[];
    courses: number[];
    properties: {
      device_id: number;
      device_name: string;
      device_imei: string;
      start_time: string;
      end_time: string;
      point_count: number;
    };
  };
}

// Trip settings (user preferences for segmentation)
interface TripSettings {
  stop_splits_trip_after_minutes: number;
  minimum_trip_duration_minutes: number;
  stop_speed_threshold_kmh: number;
}

// Suggested trip segment (from auto-detection)
interface SuggestedTrip {
  start_time: string;
  end_time: string;
  point_count: number;
  total_distance_km: number;
  start_lat: number;
  start_lon: number;
  end_lat: number;
  end_lon: number;
}
```

---

## 3. Screens / Components to Add or Update

### 3.1 Trip List Screen

**Endpoint:** `GET /api/trips?device_id={id}` (device_id optional)

**UI:**
- List of saved trips (card or list item per trip)
- Show `display_name` if available, else `name`
- Show `start_time`, `end_time`, `total_distance_km`
- Pull-to-refresh
- Tap → navigate to Trip Detail
- Optional: filter by device (dropdown or tab)

### 3.2 Trip Detail Screen

**Endpoint:** `GET /api/trips/{trip_id}`

**UI:**
- Map with route polyline (use `route.coordinates` — format is `[lon, lat]`)
- Trip info: name, display_name, device_name, start/end time, distance
- Optional: playback / animate along route using `timestamps` and `speeds`
- Delete button → `DELETE /api/trips/{trip_id}`

### 3.3 Create Trip Screen / Flow

**Option A: Manual time range**
- User selects device, start time, end time, name
- `POST /api/trips` with `{ device_id, name, start_time, end_time }`
- `display_name` is auto-generated by backend (reverse geocoding)

**Option B: From suggested trips**
- User opens "Suggested Trips" for a device
- Backend: `GET /api/trips/suggested?device_id=1&start_time=&end_time=`
- Show list of suggested segments
- User taps one → pre-fill create form or create directly
- `POST /api/trips` with the segment's `start_time` and `end_time`

### 3.4 Trip Settings Screen

**Endpoints:**
- `GET /api/trips/settings` — load current settings
- `PUT /api/trips/settings` — save (partial update)

**UI:**
- **Stop splits trip after (minutes):** Slider or number input (e.g. 10, 30, 60, 120)
  - "If the vehicle stops longer than X minutes, treat it as a new trip"
- **Minimum trip duration (minutes):** Slider or input (e.g. 0, 5, 10)
  - "Ignore segments shorter than X minutes"
- **Stop speed threshold (km/h):** Input (default 5)
  - "Speed below this = 'stopped' for segmentation"
- Save button

### 3.5 Suggested Trips Screen (optional)

**Endpoint:** `GET /api/trips/suggested?device_id=1&start_time=2025-01-01T00:00:00&end_time=2025-01-02T00:00:00`

**UI:**
- Device selector
- Date/time range picker (default: last 24h)
- List of suggested segments (uses user's trip settings)
- Each item: start/end time, distance, point count
- "Save as trip" → opens create flow with pre-filled times

---

## 4. API Endpoints Summary

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/trips` | List user's trips |
| GET | `/api/trips?device_id=1` | List trips for device |
| GET | `/api/trips/{id}` | Trip detail + route |
| POST | `/api/trips` | Create trip |
| DELETE | `/api/trips/{id}` | Delete trip |
| GET | `/api/trips/settings` | Get trip settings |
| PUT | `/api/trips/settings` | Update trip settings |
| GET | `/api/trips/suggested?device_id=1` | Get suggested segments |

---

## 5. Map Integration

**Route format:** `route.coordinates` is `[[lon, lat], [lon, lat], ...]`

**React Native Maps (e.g. react-native-maps):**
```tsx
<Polyline
  coordinates={route.coordinates.map(([lon, lat]) => ({ latitude: lat, longitude: lon }))}
  strokeColor="#007AFF"
  strokeWidth={4}
/>
```

---

## 6. Navigation Structure Suggestion

```
Tabs / Drawer
├── Devices
├── Trips
│   ├── Trip List
│   ├── Trip Detail (/:tripId)
│   ├── Create Trip
│   └── Trip Settings (or under Profile)
└── Suggested Trips (or inside Trips tab)
```

---

## 7. Error Handling

- **404:** Trip or device not found
- **400:** No location data in time range (create trip) — show user-friendly message

---

## 8. Display Name Usage

Prefer `display_name` over `name` when showing trips to users:

```tsx
<Text>{trip.display_name || trip.name}</Text>
```

`display_name` is generated from reverse geocoding (e.g. "KG 217 Street, Kigali → KG 17 Avenue, Kigali").
